//==============================================================================
// test_initial_condition_generator.cpp
// Integration test for InitialConditionGenerator + SpectralTransformer:
//   1) Packs (U^+, ψ_c, f_c) spectral fields to Newton vector and unpacks back;
//      compares against high-precision reference signals.
//   2) Builds left/right initial state vectors via Taylor expansions at XLeft/XRight
//      and matches them against known reference spectra (Yleft_ref/Yright_ref).
// Uses `almost_equal` from common.hpp and plain `assert` for validation.
//==============================================================================

#include "InitialConditionGenerator.hpp"
#include "SpectralTransformer.hpp"
#include "common.hpp"

int main()
{
    // Problem/solver sizes and physical parameters for the reference snapshot.
    constexpr int Ntau = 128;
    constexpr int Nnewton = 3*Ntau/4;
    constexpr real_t Dim = 4.0;
    constexpr real_t Delta = 3.445501184653556;
    real_t XLeft = 0.001;   // small-x left expansion point
    real_t XRight = 0.999;  // near the right boundary

    // -------------------------------------------------------------------------
    // Reference center field f_c(τ) (periodic, τ-grid of size Ntau).
    // Data are duplicated for the second half (even symmetry), as used by code.
    // -------------------------------------------------------------------------
    vec_real fc = {
      0.1808380386902108, 0.1879817629154226, 0.195750311784528,
      0.2040754293224346, 0.212735080335177, 0.2218194463190475,
      0.2316440236917176, 0.2422380865726138, 0.2533402700369832,
      0.264970520733278, 0.2775522486384674, 0.2912708790336831,
      0.3058111253120048, 0.3211042291246717, 0.3377907016263587,
      0.3563204259546532, 0.3761710832540399, 0.3968603427709224,
      0.4187493415139454, 0.4403825991177104, 0.4546081103205145,
      0.4504578760933276, 0.4220987415884616, 0.3756652438461071,
      0.3251643706628328, 0.2815542162740102, 0.2471269021206548,
      0.2193703812182967, 0.1966634957238284, 0.1788268470872672,
      0.1649037663754097, 0.1532676316383814, 0.1433507799095123,
      0.135488217509052, 0.129392084614691, 0.1241750322615097,
      0.1196155369711193, 0.1161420921678894, 0.1136878756949384,
      0.1116455249218912, 0.10988283023031, 0.1088122349051983,
      0.1084598113815031, 0.1083578940781669, 0.1083927757053566,
      0.108937009930474, 0.1100672215649373, 0.1114029494249553,
      0.1128257682983478, 0.1146642894872628, 0.1170304336358546,
      0.1196094118885933, 0.1222697811277478, 0.125296795605042,
      0.1288330825892956, 0.1326213571915234, 0.1365134779136375,
      0.1407516652973672, 0.1455095267561607, 0.1505859551105928,
      0.1558129107269667, 0.1613877835602696, 0.1675191507654918,
      0.1740665281993895,
      0.1808380386902108, 0.1879817629154226, 0.195750311784528,
      0.2040754293224346, 0.212735080335177, 0.2218194463190475,
      0.2316440236917176, 0.2422380865726138, 0.2533402700369832,
      0.264970520733278, 0.2775522486384674, 0.2912708790336831,
      0.3058111253120048, 0.3211042291246717, 0.3377907016263587,
      0.3563204259546532, 0.3761710832540399, 0.3968603427709224,
      0.4187493415139454, 0.4403825991177104, 0.4546081103205145,
      0.4504578760933276, 0.4220987415884616, 0.3756652438461071,
      0.3251643706628328, 0.2815542162740102, 0.2471269021206548,
      0.2193703812182967, 0.1966634957238284, 0.1788268470872672,
      0.1649037663754097, 0.1532676316383814, 0.1433507799095123,
      0.135488217509052, 0.129392084614691, 0.1241750322615097,
      0.1196155369711193, 0.1161420921678894, 0.1136878756949384,
      0.1116455249218912, 0.10988283023031, 0.1088122349051983,
      0.1084598113815031, 0.1083578940781669, 0.1083927757053566,
      0.108937009930474, 0.1100672215649373, 0.1114029494249553,
      0.1128257682983478, 0.1146642894872628, 0.1170304336358546,
      0.1196094118885933, 0.1222697811277478, 0.125296795605042,
      0.1288330825892956, 0.1326213571915234, 0.1365134779136375,
      0.1407516652973672, 0.1455095267561607, 0.1505859551105928,
      0.1558129107269667, 0.1613877835602696, 0.1675191507654918,
      0.1740665281993895
    };

    // ψ_c(τ) reference (odd symmetry encoded via sign flip in second half).
    vec_real psic = {
      10.26222609354186, 11.1343057747072, 11.57649284260152, 11.26753794347619,
      11.44286686599821, 12.60484410221684, 13.41474468039184, 13.20230950837687,
      13.48463453363873, 15.19261086124596, 16.60395245135067, 16.44147142081621,
      16.70810149706787, 19.14979791043472, 21.17127146679574, 19.75064742430401,
      17.17446868074634, 15.70275056120696, 6.429695341544832, -26.77111786395535,
      -85.38989343034221, -143.7886747757664, -167.6991584410922, -145.8887480476787,
      -98.53214664231069, -54.84001722720177, -28.53952826718909, -15.92919143368281,
      -9.583900233750798, -6.801583380264298, -7.09312489817704, -8.51005136135935,
      -8.927446262377153, -8.278847034424064, -7.660355929669191, -7.341289469694565,
      -6.768454875285182, -5.82100167033852, -5.067996955644391, -4.917010201935183,
      -5.120124887339915, -5.249775106148154, -5.337621323317927, -5.751999346980771,
      -6.522557205991591, -7.188687002382733, -7.48875842682688, -7.770476246063493,
      -8.341883873329053, -8.846680072642171, -8.854936068473675, -8.679833944362532,
      -8.862095873017426, -9.173424057004862, -9.032692220358429, -8.660070999323699,
      -8.764876144446244, -9.231282226932134, -9.300315623178006, -9.031059968510771,
      -9.260985966392893, -9.998575345435324, -10.30492346474401, -10.05774112945161,
      -10.26222609354186, -11.1343057747072, -11.57649284260152, -11.26753794347619,
      -11.44286686599821, -12.60484410221684, -13.41474468039184, -13.20230950837687,
      -13.48463453363873, -15.19261086124596, -16.60395245135067, -16.44147142081621,
      -16.70810149706787, -19.14979791043472, -21.17127146679574, -19.75064742430401,
      -17.17446868074634, -15.70275056120696, -6.429695341544832, 26.77111786395535,
      85.38989343034221, 143.7886747757664, 167.6991584410922, 145.8887480476787,
      98.53214664231069, 54.84001722720177, 28.53952826718909, 15.92919143368281,
      9.583900233750798, 6.801583380264298, 7.09312489817704, 8.51005136135935,
      8.927446262377153, 8.278847034424064, 7.660355929669191, 7.341289469694565,
      6.768454875285182, 5.82100167033852, 5.067996955644391, 4.917010201935183,
      5.120124887339915, 5.249775106148154, 5.337621323317927, 5.751999346980771,
      6.522557205991591, 7.188687002382733, 7.48875842682688, 7.770476246063493,
      8.341883873329053, 8.846680072642171, 8.854936068473675, 8.679833944362532,
      8.862095873017426, 9.173424057004862, 9.032692220358429, 8.660070999323699,
      8.764876144446244, 9.231282226932134, 9.300315623178006, 9.031059968510771,
      9.260985966392893, 9.998575345435324, 10.30492346474401, 10.05774112945161
    };

    // U^+(τ) reference; periodic with odd symmetry across Ntau/2.
    vec_real Up = {
      0.5709939055733149, 0.5737538511432649, 0.5757121689263367,
      0.5769323088794193, 0.577464411725264, 0.5773437223567705,
      0.5765901648942927, 0.5752082791678162, 0.5731873143319773,
      0.5705023034563158, 0.5671165795791635, 0.5629851058559669,
      0.5580580306384086, 0.5522846950711192, 0.545618088882736,
      0.5380185818873037, 0.5294555081081391, 0.5199061007054337,
      0.5093518171518134, 0.4977720638448643, 0.4851362202462511,
      0.4713965886497543, 0.4564853107080293, 0.4403167879413634,
      0.4227956346623745, 0.4038294195940506, 0.3833436743018322,
      0.3612937495346327, 0.3376675811498947, 0.312477584341956,
      0.2857458725275592, 0.2574904808138207, 0.2277203665409957,
      0.1964442857172863, 0.1636921991295979, 0.1295388966740283,
      0.09411569415075559, 0.05760413427046689, 0.02021997551811937,
      -0.01779831493373147, -0.05619080352167122, -0.09467335988745054,
      -0.1329395066360981, -0.1706686124919726, -0.2075374134409656,
      -0.2432336015835264, -0.2774719342089242, -0.3100098336892132,
      -0.340655883074039, -0.3692682524596023, -0.3957484533267343,
      -0.4200390276088794, -0.4421276260029315, -0.4620513866499929,
      -0.4798938504010233, -0.4957726258218398, -0.5098225786638442,
      -0.5221807833972771, -0.5329767796953704, -0.542328721197001,
      -0.550344291348262, -0.5571240548846619, -0.5627643760828809,
      -0.5673581786157592, -0.5709939055733149, -0.5737538511432649,
      -0.5757121689263367, -0.5769323088794193, -0.577464411725264,
      -0.5773437223567705, -0.5765901648942927, -0.5752082791678162,
      -0.5731873143319773, -0.5705023034563158, -0.5671165795791635,
      -0.5629851058559669, -0.5580580306384086, -0.5522846950711192,
      -0.545618088882736, -0.5380185818873037, -0.5294555081081391,
      -0.5199061007054337, -0.5093518171518134, -0.4977720638448643,
      -0.4851362202462511, -0.4713965886497543, -0.4564853107080293,
      -0.4403167879413634, -0.4227956346623745, -0.4038294195940506,
      -0.3833436743018322, -0.3612937495346327, -0.3376675811498947,
      -0.312477584341956, -0.2857458725275592, -0.2574904808138207,
      -0.2277203665409957, -0.1964442857172863, -0.1636921991295979,
      -0.1295388966740283, -0.09411569415075559, -0.05760413427046689,
      -0.02021997551811937, 0.01779831493373147, 0.05619080352167122,
      0.09467335988745054, 0.1329395066360981, 0.1706686124919726,
      0.2075374134409656, 0.2432336015835264, 0.2774719342089242,
      0.3100098336892132, 0.340655883074039, 0.3692682524596023,
      0.3957484533267343, 0.4200390276088794, 0.4421276260029315,
      0.4620513866499929, 0.4798938504010233, 0.4957726258218398,
      0.5098225786638442, 0.5221807833972771, 0.5329767796953704,
      0.542328721197001, 0.550344291348262, 0.5571240548846619,
      0.5627643760828809, 0.5673581786157592
    };

    // -------------------------------------------------------------------------
    // “Unpacked” reference fields (expected outputs after pack→unpack roundtrip)
    // -------------------------------------------------------------------------
    vec_real Up_unpack_ref = {
        0.5709939055733146, 0.573753851143265, 0.5757121689263367,
        0.5769323088794192, 0.5774644117252639, 0.5773437223567705,
        0.5765901648942926, 0.5752082791678161, 0.5731873143319773,
        0.5705023034563158, 0.5671165795791635, 0.5629851058559667,
        0.5580580306384085, 0.5522846950711191, 0.5456180888827361,
        0.5380185818873033, 0.5294555081081392, 0.5199061007054339,
        0.5093518171518135, 0.4977720638448642, 0.4851362202462512,
        0.4713965886497543, 0.4564853107080297, 0.4403167879413632,
        0.4227956346623748, 0.4038294195940506, 0.3833436743018325,
        0.3612937495346324, 0.3376675811498948, 0.312477584341956,
        0.2857458725275595, 0.2574904808138202, 0.2277203665409962,
        0.1964442857172862, 0.1636921991295979, 0.1295388966740281,
        0.09411569415075578, 0.05760413427046679, 0.02021997551811962,
        -0.01779831493373176, -0.05619080352167088, -0.09467335988745065,
        -0.132939506636098, -0.1706686124919727, -0.2075374134409654,
        -0.2432336015835264, -0.277471934208924, -0.3100098336892135,
        -0.3406558830740386, -0.3692682524596026, -0.3957484533267344,
        -0.4200390276088795, -0.4421276260029313, -0.462051386649993,
        -0.4798938504010232, -0.49577262582184, -0.509822578663844,
        -0.5221807833972774, -0.5329767796953704, -0.5423287211970009,
        -0.5503442913482619, -0.5571240548846619, -0.5627643760828809,
        -0.5673581786157592, -0.5709939055733146, -0.573753851143265,
        -0.5757121689263367, -0.5769323088794192, -0.5774644117252639,
        -0.5773437223567705, -0.5765901648942926, -0.5752082791678161,
        -0.5731873143319773, -0.5705023034563158, -0.5671165795791635,
        -0.5629851058559667, -0.5580580306384085, -0.5522846950711191,
        -0.5456180888827361, -0.5380185818873033, -0.5294555081081392,
        -0.5199061007054339, -0.5093518171518135, -0.4977720638448642,
        -0.4851362202462512, -0.4713965886497543, -0.4564853107080297,
        -0.4403167879413632, -0.4227956346623748, -0.4038294195940506,
        -0.3833436743018325, -0.3612937495346324, -0.3376675811498948,
        -0.312477584341956, -0.2857458725275595, -0.2574904808138202,
        -0.2277203665409962, -0.1964442857172862, -0.1636921991295979,
        -0.1295388966740281, -0.09411569415075578, -0.05760413427046679,
        -0.02021997551811962, 0.01779831493373176, 0.05619080352167088,
        0.09467335988745065, 0.132939506636098, 0.1706686124919727,
        0.2075374134409654, 0.2432336015835264, 0.277471934208924,
        0.3100098336892135, 0.3406558830740386, 0.3692682524596026,
        0.3957484533267344, 0.4200390276088795, 0.4421276260029313,
        0.462051386649993, 0.4798938504010232, 0.49577262582184,
        0.509822578663844, 0.5221807833972774, 0.5329767796953704,
        0.5423287211970009, 0.5503442913482619, 0.5571240548846619,
        0.5627643760828809, 0.5673581786157592
    };

    vec_real psic_unpack_ref = {
        10.26222609354187, 11.1343057747072, 11.57649284260151,
        11.26753794347619, 11.44286686599821, 12.60484410221684,
        13.41474468039187, 13.20230950837686, 13.48463453363873,
        15.19261086124595, 16.60395245135069, 16.4414714208162,
        16.70810149706787, 19.14979791043471, 21.17127146679575,
        19.75064742430397, 17.17446868074639, 15.70275056120694,
        6.429695341544841, -26.77111786395538, -85.38989343034217,
        -143.7886747757665, -167.6991584410923, -145.8887480476787,
        -98.53214664231069, -54.84001722720178, -28.53952826718911,
        -15.92919143368278, -9.583900233750811, -6.801583380264296,
        -7.093124898177052, -8.510051361359329, -8.92744626237716,
        -8.278847034424068, -7.660355929669188, -7.341289469694559,
        -6.76845487528519, -5.821001670338511, -5.067996955644396,
        -4.917010201935188, -5.120124887339919, -5.249775106148151,
        -5.337621323317935, -5.751999346980767, -6.522557205991586,
        -7.188687002382746, -7.488758426826893, -7.770476246063486,
        -8.341883873329055, -8.846680072642167, -8.854936068473677,
        -8.67983394436253, -8.86209587301744, -9.173424057004842,
        -9.03269222035844, -8.660070999323692, -8.764876144446239,
        -9.231282226932137, -9.300315623178005, -9.031059968510768,
        -9.260985966392898, -9.998575345435322, -10.304923464744,
        -10.0577411294516, -10.26222609354187, -11.1343057747072,
        -11.57649284260151, -11.26753794347619, -11.44286686599821,
        -12.60484410221684, -13.41474468039187, -13.20230950837686,
        -13.48463453363873, -15.19261086124595, -16.60395245135069,
        -16.4414714208162, -16.70810149706787, -19.14979791043471,
        -21.17127146679575, -19.75064742430397, -17.17446868074639,
        -15.70275056120694, -6.429695341544841, 26.77111786395538,
        85.38989343034217, 143.7886747757665, 167.6991584410923,
        145.8887480476787, 98.53214664231069, 54.84001722720178,
        28.53952826718911, 15.92919143368278, 9.583900233750811,
        6.801583380264296, 7.093124898177052, 8.510051361359329,
        8.92744626237716, 8.278847034424068, 7.660355929669188,
        7.341289469694559, 6.76845487528519, 5.821001670338511,
        5.067996955644396, 4.917010201935188, 5.120124887339919,
        5.249775106148151, 5.337621323317935, 5.751999346980767,
        6.522557205991586, 7.188687002382746, 7.488758426826893,
        7.770476246063486, 8.341883873329055, 8.846680072642167,
        8.854936068473677, 8.67983394436253, 8.86209587301744,
        9.173424057004842, 9.03269222035844, 8.660070999323692,
        8.764876144446239, 9.231282226932137, 9.300315623178005,
        9.031059968510768, 9.260985966392898, 9.998575345435322,
        10.304923464744, 10.0577411294516
    };

    vec_real fc_unpack_ref = {
        0.1808380386902109, 0.1879817629154228, 0.1957503117845282,
        0.2040754293224348, 0.212735080335177, 0.2218194463190477,
        0.2316440236917177, 0.2422380865726139, 0.2533402700369832,
        0.2649705207332781, 0.2775522486384674, 0.2912708790336832,
        0.3058111253120047, 0.3211042291246717, 0.3377907016263587,
        0.3563204259546532, 0.3761710832540398, 0.3968603427709225,
        0.4187493415139454, 0.4403825991177103, 0.4546081103205145,
        0.4504578760933275, 0.4220987415884616, 0.3756652438461069,
        0.3251643706628329, 0.2815542162740101, 0.2471269021206547,
        0.2193703812182965, 0.1966634957238284, 0.178826847087267,
        0.1649037663754095, 0.1532676316383812, 0.1433507799095123,
        0.1354882175090519, 0.1293920846146909, 0.1241750322615095,
        0.1196155369711192, 0.1161420921678892, 0.1136878756949383,
        0.1116455249218911, 0.1098828302303099, 0.1088122349051982,
        0.108459811381503, 0.1083578940781668, 0.1083927757053565,
        0.108937009930474, 0.1100672215649372, 0.1114029494249554,
        0.1128257682983478, 0.1146642894872628, 0.1170304336358547,
        0.1196094118885934, 0.1222697811277477, 0.1252967956050421,
        0.1288330825892957, 0.1326213571915235, 0.1365134779136376,
        0.1407516652973674, 0.1455095267561608, 0.150585955110593,
        0.1558129107269668, 0.1613877835602697, 0.1675191507654919,
        0.1740665281993897, 0.1808380386902109, 0.1879817629154228,
        0.1957503117845282, 0.2040754293224348, 0.212735080335177,
        0.2218194463190477, 0.2316440236917177, 0.2422380865726139,
        0.2533402700369832, 0.2649705207332781, 0.2775522486384674,
        0.2912708790336832, 0.3058111253120047, 0.3211042291246717,
        0.3377907016263587, 0.3563204259546532, 0.3761710832540398,
        0.3968603427709225, 0.4187493415139454, 0.4403825991177103,
        0.4546081103205145, 0.4504578760933275, 0.4220987415884616,
        0.3756652438461069, 0.3251643706628329, 0.2815542162740101,
        0.2471269021206547, 0.2193703812182965, 0.1966634957238284,
        0.178826847087267, 0.1649037663754095, 0.1532676316383812,
        0.1433507799095123, 0.1354882175090519, 0.1293920846146909,
        0.1241750322615095, 0.1196155369711192, 0.1161420921678892,
        0.1136878756949383, 0.1116455249218911, 0.1098828302303099,
        0.1088122349051982, 0.108459811381503, 0.1083578940781668,
        0.1083927757053565, 0.108937009930474, 0.1100672215649372,
        0.1114029494249554, 0.1128257682983478, 0.1146642894872628,
        0.1170304336358547, 0.1196094118885934, 0.1222697811277477,
        0.1252967956050421, 0.1288330825892957, 0.1326213571915235,
        0.1365134779136376, 0.1407516652973674, 0.1455095267561608,
        0.150585955110593, 0.1558129107269668, 0.1613877835602697,
        0.1675191507654919, 0.1740665281993897
    };

    // -------------------------------------------------------------------------
    // Instantiate generator and perform pack→unpack round-trip checks.
    // -------------------------------------------------------------------------
    InitialConditionGenerator icg(Ntau, Dim, Delta);

    vec_real packed(Nnewton), Up_unpack(Ntau), psic_unpack(Ntau), fc_unpack(Ntau);

    icg.packSpectralFields(Up, psic, fc, packed);
    icg.unpackSpectralFields(packed, Up_unpack, psic_unpack, fc_unpack);

    for (size_t i = 0; i < Ntau; ++i)
    {
        assert(almost_equal(Up_unpack[i], Up_unpack_ref[i]));
        assert(almost_equal(psic_unpack[i], psic_unpack_ref[i]));
        assert(almost_equal(fc_unpack[i], fc_unpack_ref[i]));
    }

    // -------------------------------------------------------------------------
    // Left/right Taylor expansions at XLeft/XRight and reference comparison.
    // Y stores the spectral state vector after expansion; we compare entrywise.
    // -------------------------------------------------------------------------
    vec_complex Yleft(Ntau), Yright(Ntau);

    vec_complex Yleft_ref = {
        {0, 0.2071965806060965}, {0.008104277009724523, 0.0006317579240481063}, {3.445501184653556, -1.284061112972264e-06},
        {-0.002808740849460946, 0.002210486769921419}, {0.01438235352713204, -0.02371121913736543}, {-0.0001741509658177878, -0.002138226926079286},
        {0.006459552613559752, 0.01347344732259571}, {0.001268801688122256, 0.0006297457275202321}, {-0.008835075580628127, -0.00111083717383678},
        {-0.0008377161395001038, 0.0005329668949444254}, {0.003560201906633433, -0.004332902733759056}, {-7.663262380103583e-06, -0.0007007458702112264},
        {0.001173289812139722, 0.003461683222197575}, {0.0004245138326249426, 0.000256210360417733}, {-0.002376097757702392, -0.0005441001577537903},
        {-0.0003105971384774229, 0.0001621030745795838}, {0.001154946346218138, -0.001181734682234523}, {1.433663850679228e-05, -0.0002469921028659425},
        {0.00028086927801872, 0.001098481918900735}, {0.0001453319817246327, 9.698541199814692e-05}, {-0.000751687840066222, -0.0002278746196434126},
        {-0.0001103975006381686, 5.484215304177615e-05}, {0.000407413413021986, -0.0003671947018213979}, {4.311501160635147e-06, -8.653679235093431e-05},
        {7.380196079227933e-05, 0.0003785154958082793}, {5.154176701324534e-05, 3.142457241448825e-05}, {-0.0002567392732139128, -9.243397629119874e-05},
        {-3.521469803499894e-05, 2.131471280339788e-05}, {0.0001494688560913192, -0.0001239118712326722}, {-2.740540140886807e-06, -2.641242381014088e-05},
        {2.349454030038871e-05, 0.0001366951226223292}, {1.387416010333173e-05, 3.061498903529404e-06}, {0, -6.610053734866506e-05},
        {3.13850181924059e-06, 1.338483226194528e-05}, {-2.349454030038721e-05, 0.0001366951226223316}, {-2.498307598460198e-05, -2.907948670102562e-06},
        {-0.0001494688560913196, -0.0001239118712326724}, {2.055671455110031e-05, -3.306844835316562e-05}, {0.0002567392732139124, -9.243397629119833e-05},
        {2.922411321185496e-05, 4.919477038582432e-05}, {-7.380196079227947e-05, 0.0003785154958082789}, {-8.228292033340333e-05, 3.171086170333727e-06},
        {-0.0004074134130219859, -0.0003671947018213976}, {5.340624417260712e-05, -0.0001046305588259781}, {0.0007516878400662234, -0.0002278746196434126},
        {9.125403928529953e-05, 0.0001398454472297022}, {-0.0002808692780187202, 0.001098481918900735}, {-0.0002368896049627925, 1.149783650414929e-05},
        {-0.001154946346218138, -0.001181734682234523}, {0.0001583899588491636, -0.000297388035058569}, {0.002376097757702391, -0.0005441001577537915},
        {0.000244414760093507, 0.0004114394923704994}, {-0.001173289812139723, 0.003461683222197576}, {-0.0006791267735917115, -1.106244816114586e-05},
        {-0.003560201906633433, -0.004332902733759056}, {0.0005221443320393006, -0.0008140294261007256}, {0.008835075580628127, -0.00111083717383678},
        {0.0006131441023065243, 0.00124497484812696}, {-0.006459552613559752, 0.01347344732259571}, {-0.00210518573487124, -0.0001774878516419925},
        {-0.01438235352713204, -0.02371121913736543}, {0.002196015466527208, -0.002777068586398931}, {0.06490807211829409, -1.284061112972025e-06},
        {0.0006069421874576825, 0.008082609120441441}
    };

    vec_complex Yright_ref = {
         {0, 0.9996136363634085}, {0.4378565466078522, 0.1678568117784718}, {3.445501184653556, -4.554756511469362e-05},
        {-0.01025190938486636, -0.0242638048463067}, {-1.153016830105564e-06, 4.579183716810811e-06}, {-0.002210266838748053, 0.001673898823878751},
        {5.541653072191704e-07, -1.784413606144513e-08}, {0.0002486327092144807, 0.0001245379043382825}, {-2.841372718679651e-08, -4.839041728580847e-08},
        {6.293746911866599e-05, -0.0001012703934905039}, {-1.655004804455927e-08, 8.127924542048773e-09}, {3.738024982879971e-05, 2.088729248560459e-05},
        {2.296761288833276e-10, -1.379915775846749e-09}, {-2.071069862866182e-05, -6.364152728662855e-06}, {5.99697067688631e-10, 1.605257650374369e-09},
        {9.600835849938325e-06, -8.758778966891844e-06}, {-1.721049778057061e-10, -1.342914818125587e-11}, {-8.294364280461504e-06, 2.459034521215992e-06},
        {3.395801016629434e-10, 2.662321531693102e-11}, {2.289979388280459e-06, 9.405597908800011e-07}, {-7.595180377834982e-11, -1.250008344643651e-10},
        {-3.46655881213467e-07, 1.890470013888855e-07}, {-1.463831189368073e-11, 2.055371040754475e-11}, {5.511228875440787e-07, -2.203171865001556e-07},
        {-7.058140939885805e-12, 6.688292395424545e-12}, {-3.280718033967983e-07, -2.0079692479446e-07}, {6.557123150658038e-12, 4.146961123779738e-12},
        {3.072350581158702e-08, 2.223979148136995e-07}, {2.502107905547241e-13, -5.659802646920464e-12}, {7.339091356595925e-08, -6.7456674819917e-08},
        {-3.78815906450008e-12, 5.750219581703626e-13}, {1.67385078715202e-09, 2.337868835173706e-08}, {0, -7.338019081259972e-13},
        {1.595315629598915e-09, -2.255998932110259e-08}, {3.7881590649291e-12, 5.750219568621644e-13}, {7.069291482536197e-08, 6.502295716963313e-08},
        {-2.50210790296814e-13, -5.659802646925949e-12}, {2.961106705987688e-08, -2.136261032060572e-07}, {-6.557123150635433e-12, 4.146961123828191e-12},
        {-3.1419103120859e-07, 1.920560582858557e-07}, {7.058140939887446e-12, 6.688292395422138e-12}, {5.251861122710134e-07, 2.102262804202568e-07},
        {1.463831189367366e-11, 2.055371040757224e-11}, {-3.289846830420418e-07, -1.7784575178807e-07}, {7.595180377819179e-11, -1.250008344643112e-10},
        {2.166498360881702e-06, -8.894323698270187e-07}, {-3.395801016628268e-10, 2.662321531547056e-11}, {-7.779760304529046e-06, -2.311232128664664e-06},
        {1.721049778057061e-10, -1.342914818125587e-11}, {8.91432597774166e-06, 8.127114888523139e-06}, {-5.996970676894454e-10, 1.605257650373209e-09},
        {-1.904372991228157e-05, 5.859240152175397e-06}, {-2.296761288833256e-10, -1.379915775846803e-09}, {3.353435518208162e-05, -1.886441226158036e-05},
        {1.655004804455927e-08, 8.127924542048774e-09}, {5.555100052810753e-05, 9.144060027705558e-05}, {2.841372718679651e-08, -4.839041728580848e-08},
        {0.0002286721097157944, -0.0001125738781901182}, {-5.541653072191704e-07, -1.784413606144513e-08}, {-0.001896431369783741, -0.001501276014717273},
        {1.153016830105564e-06, 4.579183716810811e-06}, {-0.007905400460454341, 0.01971038295038418}, {3.620333367207922e-05, -4.554756511469362e-05},
        {0.1548850030286238, -0.01278402094355271}   
    };

    // Generate expansions from the unpacked fields and validate against refs.
    icg.computeLeftExpansion(XLeft, fc_unpack, psic_unpack, Yleft, Delta, false);
    icg.computeRightExpansion(XRight, Up_unpack, Yright, Delta, false);

    for (size_t i = 0; i < Ntau; ++i)
    {
        assert(almost_equal(Yleft[i], Yleft_ref[i]));
        assert(almost_equal(Yright[i], Yright_ref[i]));
    }

    return 0;
}
